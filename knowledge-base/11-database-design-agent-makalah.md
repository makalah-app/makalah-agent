UID: database-design-agent-makalah
Title: Database Design Document for Agent-Makalah
Author: "ERIK SUPIT"
Version: 1.0
Date: "1 Juni 2025"
Role: DATABASE-DESIGN
Status: FINAL
Domain: SOFTWARE-ENGINEERING
Dependencies:
  - "srs-agent-makalah"
  - "memory-session-agent-makalah"
  - "backend-architecture-agent-makalah"
  - "technology-stack-agent-makalah"
  - "sop-tools-agent-makalah" # Added dependency
Anchors:
  - "ddam-root"
  - "ddam-introduction"
  - "ddam-architectural-context"
  - "ddam-core-entities-relationships"
  - "ddam-schema-conceptual"
  - "ddam-table-sessions"
  - "ddam-table-conversation-turns"
  - "ddam-table-artifacts"
  - "ddam-table-uploaded-files"
  - "ddam-data-integrity-constraints"
  - "ddam-performance-considerations"
  - "ddam-security-considerations-db"
  - "ddam-future-enhancements"
  - "ddam-revision-history"
Tags:
  - "database-design"
  - "schema"
  - "postgresql"
  - "supabase"
  - "agent-makalah"
  - "data-persistence"
  - "mvp"
Language: EN
Chained: true
---

---
> Segment-ID: DDAM-INTRO-001
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Overview of the database design document's purpose, scope, and target audience.

## 1. Introduction and Purpose {#ddam-introduction}

This Database Design Document provides a detailed specification of the logical and conceptual physical database schema for the `Agent-Makalah` system. It defines the tables, columns, data types, relationships, and key considerations for reliable and efficient data persistence. This document serves as a foundational guide for the database administrators and software developers responsible for implementing, managing, and interacting with `Agent-Makalah`'s primary relational database.

The primary purpose is to ensure robust support for `Agent-Makalah`'s functional requirements, particularly those related to persistent conversation history, agent state tracking, iterative workflow management, and the traceability of intermediate work products (artifacts). It aligns with the data persistence strategy outlined in `memory-session-agent-makalah` and integrates with the overall backend architecture defined in `backend-architecture-agent-makalah`, leveraging PostgreSQL as the chosen relational database technology.

This document specifically focuses on the design of the PostgreSQL database component, which will be provisioned via Supabase. It outlines how conversational data, workflow progress, artifact metadata, and uploaded file metadata will be structured and stored. Other data stores, such as Redis (for caching) and Google Cloud Storage (for raw uploaded files), are integrated at the application layer, with only their relevant metadata stored within this relational database.

---
> Segment-ID: DDAM-ARCH-CONTEXT-002
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Places the database within the overall Agent-Makalah system architecture and its role.

## 2. Architectural Context {#ddam-architectural-context}

The database layer serves as the central persistent data store for the `Agent-Makalah` system. It provides the backbone for managing user sessions, maintaining conversational context across turns, preserving intermediate artifacts generated by agents, and tracking the overall progress of complex workflows.

As per `backend-architecture-agent-makalah`, this PostgreSQL database (managed by Supabase) is part of the Data Persistence Layer. It is primarily accessed by the Backend API Gateway (FastAPI) for storing and retrieving session-related data, conversation history, and artifact metadata. ADK Agents interact with this layer indirectly via the Backend API or through ADK's state management which maps to this persistence layer.

The design ensures that critical data for `Agent-Makalah`'s unique features, such as interactive revision loops, comprehensive work traceability, and user accountability, is securely and reliably stored.

---
> Segment-ID: DDAM-CORE-ENTITIES-003
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Describes the core data entities and their high-level relationships within the Agent-Makalah database.

## 3. Core Data Entities and Relationships {#ddam-core-entities-relationships}

The `Agent-Makalah` database design revolves around several key entities that represent the fundamental data points within a user's interaction journey:

*   **User Sessions:** The primary container for a single, continuous user interaction with `Agent-Makalah`. All activities are tied to a session.
*   **Conversation Turns:** Individual messages exchanged between the user and the `Orchestrator_Agent`, forming the dialogue history.
*   **Artifacts:** The significant, structured work products generated and validated by agents at various stages of the academic workflow (e.g., definitive topic, reference list, outline, drafted section, analysis report).
*   **Uploaded Files Metadata:** Descriptive information about files uploaded by the user, with the actual file content stored externally in object storage.

These entities are designed to be strongly related to each other, primarily through the `session_id`, ensuring referential integrity and enabling comprehensive data retrieval for any given session.

---
> Segment-ID: DDAM-SCHEMA-CONCEPTUAL-004
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Presents the conceptual database schema, detailing tables, their purpose, and key columns.

## 4. Proposed Database Schema (Conceptual) {#ddam-schema-conceptual}

The following section outlines the proposed tables, their purpose, key columns, and conceptual data types for the `Agent-Makalah` PostgreSQL database. Specific indexing strategies and detailed constraints are further elaborated in subsequent sections.

### 4.1. `sessions` Table {#ddam-table-sessions}

*   **Purpose:** Stores metadata for each user interaction session with `Agent-Makalah`. It serves as the root entity, linking all conversation turns, artifacts, and uploaded files to a specific session.
*   **Key Columns:**

| Column Name            | Data Type                   | Constraints                  | Description                                            |
| :--------------------- | :-------------------------- | :--------------------------- | :----------------------------------------------------- |
| `session_id`           | `UUID`                      | `PRIMARY KEY`                | Unique identifier for the session.                     |
| `user_id`              | `UUID` or `INTEGER`         | `NOT NULL` (if authenticated)| Identifier for the user interacting with the system.   |
| `start_time`           | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Timestamp when the session began.                      |
| `end_time`             | `TIMESTAMP WITH TIME ZONE`  | `NULLABLE`                   | Timestamp when the session ended (completed, timed out, terminated). |
| `status`               | `VARCHAR(50)`               | `NOT NULL`, e.g., 'ACTIVE', 'COMPLETED', 'TIMED_OUT', 'ERROR' | Current state of the session.                          |
| `current_sop_id`       | `VARCHAR(100)`              | `NULLABLE`                   | UID of the main SOP (`SOP-AM-001`, `SOP-AM-002`) currently active in the session. |
| `current_sop_step_id`  | `VARCHAR(100)`              | `NULLABLE`                   | Identifier for the current step within the active SOP (e.g., 'Step 3: Literature Search'). |
| `last_active_time`     | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Last timestamp of user interaction or agent activity within the session. |

*   **Relationships:** One-to-many with `conversation_turns`, `artifacts`, `uploaded_files`.

### 4.2. `conversation_turns` Table {#ddam-table-conversation-turns}

*   **Purpose:** Stores the granular history of each message exchange (turn) within a specific session, providing a complete audit trail of the dialogue.
*   **Key Columns:**

| Column Name            | Data Type                   | Constraints                  | Description                                            |
| :--------------------- | :-------------------------- | :--------------------------- | :----------------------------------------------------- |
| `turn_id`              | `UUID`                      | `PRIMARY KEY`                | Unique identifier for each conversation turn.          |
| `session_id`           | `UUID`                      | `NOT NULL`, `FOREIGN KEY` -> `sessions.session_id` | Links the turn to its parent session.                  |
| `turn_number`          | `INTEGER`                   | `NOT NULL`, `UNIQUE (session_id, turn_number)` | Sequential number of the turn within the session.      |
| `timestamp`            | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Timestamp when this specific turn occurred.            |
| `speaker`              | `VARCHAR(10)`               | `NOT NULL`, e.g., 'USER', 'AGENT' | Indicates whether the message was from the user or agent. |
| `raw_input_text`       | `TEXT`                      | `NULLABLE`                   | Original text input provided by the user.              |
| `agent_output_text`    | `TEXT`                      | `NULLABLE`                   | Textual response presented by the `Orchestrator_Agent`.|
| `processed_intent_json`| `JSONB`                     | `NULLABLE`                   | Structured representation of user intent after clarification (e.g., from `SOP-AM-003`). |
| `error_code`           | `VARCHAR(20)`               | `NULLABLE`                   | If the agent's output was an error message, includes its code (e.g., 'V-006', 'P5') as defined in `sop-tools-agent-makalah#sop-am-004-error-classification`. |

*   **Relationships:** Many-to-one with `sessions`.

### 4.3. `artifacts` Table {#ddam-table-artifacts}

*   **Purpose:** Stores metadata about key intermediate work products (artifacts) generated and validated throughout the academic paper creation or analysis workflow. The actual content of large artifacts may be stored externally (e.g., GCS), with a reference here.
*   **Key Columns:**

| Column Name            | Data Type                   | Constraints                  | Description                                            |
| :--------------------- | :-------------------------- | :--------------------------- | :----------------------------------------------------- |
| `artifact_id`          | `UUID`                      | `PRIMARY KEY`                | Unique identifier for the artifact.                    |
| `session_id`           | `UUID`                      | `NOT NULL`, `FOREIGN KEY` -> `sessions.session_id` | Links the artifact to its parent session.             |
| `artifact_type`        | `VARCHAR(50)`               | `NOT NULL`, e.g., 'TOPIC', 'REFERENCE_LIST', 'OUTLINE', 'SECTION_DRAFT', 'ANALYSIS_REPORT' | Categorizes the type of work product.                  |
| `version`              | `INTEGER`                   | `NOT NULL`, `DEFAULT 1`      | Version number for the artifact (e.g., for revision loops). |
| `creation_time`        | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Timestamp when this artifact version was first created. |
| `last_updated_time`    | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Timestamp when this artifact version was last modified or validated. |
| `status`               | `VARCHAR(50)`               | `NOT NULL`, e.g., 'DRAFT', 'VALIDATED', 'REVISIONS_REQUESTED', 'FINAL' | Current validation status of the artifact.             |
| `content_reference`    | `TEXT`                      | `NULLABLE`                   | Reference to the actual content (e.g., GCS URL for large artifacts, direct JSON string for smaller structured data like topic). |
| `metadata_json`        | `JSONB`                     | `NULLABLE`                   | Flexible JSONB field for additional structured metadata specific to the artifact type (e.g., for `REFERENCE_LIST`: count of references, keywords used). |

*   **Relationships:** Many-to-one with `sessions`.

### 4.4. `uploaded_files` Table {#ddam-table-uploaded-files}

*   **Purpose:** Stores metadata about files uploaded by the user for analysis or other purposes. The actual file content is stored in Google Cloud Storage (GCS).
*   **Key Columns:**

| Column Name            | Data Type                   | Constraints                  | Description                                            |
| :--------------------- | :-------------------------- | :--------------------------- | :----------------------------------------------------- |
| `file_id`              | `UUID`                      | `PRIMARY KEY`                | Unique identifier for the uploaded file.               |
| `session_id`           | `UUID`                      | `NOT NULL`, `FOREIGN KEY` -> `sessions.session_id` | Links the uploaded file to the session it was uploaded in. |
| `user_id`              | `UUID` or `INTEGER`         | `NULLABLE` (if not authenticated) | Identifier for the user who uploaded the file.         |
| `filename`             | `VARCHAR(255)`              | `NOT NULL`                   | Original name of the uploaded file.                    |
| `file_type`            | `VARCHAR(50)`               | `NOT NULL`                   | File extension (e.g., 'pdf', 'docx', 'txt').           |
| `file_size_bytes`      | `BIGINT`                    | `NOT NULL`                   | Size of the file in bytes.                             |
| `upload_timestamp`     | `TIMESTAMP WITH TIME ZONE`  | `NOT NULL`                   | Timestamp when the file was uploaded.                  |
| `gcs_path`             | `TEXT`                      | `NOT NULL`, `UNIQUE`         | Full path or URL to the file's location in Google Cloud Storage. |
| `status`               | `VARCHAR(50)`               | `NOT NULL`, e.g., 'UPLOADED', 'PROCESSING', 'PROCESSED', 'DELETED' | Current status of the file within the system's lifecycle. |

*   **Relationships:** Many-to-one with `sessions`.

---
> Segment-ID: DDAM-INTEGRITY-005
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Specifies principles and constraints for maintaining data integrity in the database.

## 5. Data Integrity and Constraints {#ddam-data-integrity-constraints}

Data integrity is foundational for the reliability and trustworthiness of `Agent-Makalah`. The following principles and constraints will be applied:

*   **Primary Keys:** Each table will have a single-column `UUID` as its primary key. This ensures unique identification of records across potentially distributed environments and simplifies joins.
*   **Foreign Keys:** Referential integrity will be enforced using foreign keys. For example, `session_id` in `conversation_turns`, `artifacts`, and `uploaded_files` will link directly to `sessions.session_id`. This prevents orphaned records and ensures data consistency across related tables.
*   **`NOT NULL` Constraints:** Applied to essential columns that must always contain a value, ensuring data completeness for critical fields.
*   **Unique Constraints:** Applied to columns or combinations of columns where uniqueness is required beyond the primary key (e.g., `(session_id, turn_number)` in `conversation_turns`, `gcs_path` in `uploaded_files`).
*   **Check Constraints:** May be applied to enforce domain integrity (e.g., `status` fields must be one of a predefined set of values).

---
> Segment-ID: DDAM-PERF-CONSIDER-006
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Outlines performance considerations for the database design, including indexing and data types.

## 6. Performance Considerations {#ddam-performance-considerations}

Database performance is critical for `Agent-Makalah`'s responsiveness. The following considerations are incorporated:

*   **Indexing:**
    *   **Primary Keys:** Automatically indexed, ensuring fast lookups for individual records.
    *   **Foreign Keys:** Indexes will be explicitly created on all foreign key columns (e.g., `session_id` in child tables) to optimize join operations and speed up lookups from parent tables.
    *   **Frequently Queried Columns:** Additional indexes will be considered for columns frequently used in `WHERE` clauses, `ORDER BY` clauses, or `JOIN` conditions (e.g., `timestamp` for time-based filtering, `user_id` for user-specific data retrieval).
*   **`JSONB` Data Type Usage:**
    *   **Benefit:** Using `JSONB` for flexible schema fields (`processed_intent_json`, `metadata_json`) allows for efficient storage and querying of semi-structured data, supporting evolving data needs without requiring frequent schema migrations for minor changes. PostgreSQL provides operators for querying `JSONB` fields.
*   **Pagination for Large Result Sets:**
    *   **Practice:** Application-level queries retrieving potentially large result sets (e.g., retrieving entire conversation history for a long session) will implement pagination (e.g., `OFFSET`/`LIMIT`) to avoid excessive memory consumption and improve responsiveness.
*   **Optimized Queries:** SQL queries will be optimized for performance, utilizing appropriate `JOIN` types and avoiding N+1 query problems.

---
> Segment-ID: DDAM-SECURITY-CONSIDER-DB-007
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Details security measures specific to the database layer, including access, encryption, and credential management.

## 7. Security Considerations (Database Specific) {#ddam-security-considerations-db}

Security at the database layer is paramount to protect sensitive user and system data.

*   **Authentication and Authorization:**
    *   **Principle of Least Privilege:** Database users/roles will be created with minimum necessary privileges, granting only the required permissions (e.g., read-only for certain tables, specific DML permissions for application services).
    *   **Role-Based Access Control (RBAC):** Access will be controlled based on the authenticated service account or user role accessing the database.
*   **Secrets Management:**
    *   **Requirement:** Database credentials (usernames, passwords) will never be hardcoded or stored directly in application code or public repositories.
    *   **Mechanism:** Credentials will be managed securely using a dedicated secrets management service (e.g., Google Secret Manager), accessed at runtime via IAM-controlled permissions.
*   **Network Security:**
    *   **Requirement:** Database access will be strictly limited to authorized `Agent-Makalah` backend services.
    *   **Mechanism:** Utilize private IP addresses, Virtual Private Cloud (VPC) network configurations, and firewall rules to restrict database connections solely to the application's compute services (e.g., Cloud Run instances) and prevent exposure to the public internet.
*   **Data Encryption:**
    *   **Encryption at Rest:** As a managed service, Supabase provides default encryption for data stored in PostgreSQL (e.g., using disk encryption).
    *   **Encryption in Transit:** All connections to the database will enforce encryption in transit using TLS/SSL to protect data during transmission.
*   **Auditing and Logging:**
    *   **Requirement:** Database-level audit logging will be enabled to track significant database events (e.g., authentication attempts, schema changes, suspicious queries).
    *   **Mechanism:** Leverage Supabase's built-in logging capabilities which integrate with cloud logging solutions.

---
> Segment-ID: DDAM-FUTURE-ENHANCEMENTS-008
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Outlines potential future enhancements for the database architecture beyond the MVP.

## 8. Future Enhancements (Post-MVP) {#ddam-future-enhancements}

The current database design is optimized for MVP requirements. Future enhancements may include:

*   **Artifact Versioning (Advanced):** Implementing more sophisticated versioning for `artifacts` (e.g., maintaining a full history of changes for each artifact version, not just overwriting, leveraging database features or external version control for structured data).
*   **Rich Audit Trails:** Implementing granular change data capture (CDC) for key tables to provide a comprehensive and immutable audit trail of all data modifications, beyond simple logging.
*   **Full-Text Search Optimization:** Implementing full-text search capabilities (e.g., using PostgreSQL's built-in full-text search, or integrating with a dedicated search engine like Elasticsearch/OpenSearch) for conversation history and artifact content, to enable powerful content discovery.
*   **Data Archiving and Purging:** Implementing policies and mechanisms for archiving or purging old/completed session data to optimize database size, performance, and cost, while complying with the system's data retention policies, as defined in `memory-session-agent-makalah`.
*   **Vector Database Integration:** If the Knowledge Graph feature (`prd-agent-makalah#prd-future-considerations`) is pursued, integrating a specialized vector database (e.g., Pinecone, Weaviate) for storing embeddings of text and concepts.

---
> Segment-ID: DDAM-REVISION-HIST-009
> Source-File: database-design-agent-makalah
> Parent-Anchor: ddam-root
> Context: Tracks the version history and changes made to this Database Design Document.

## 9. Revision History {#ddam-revision-history}

| Version | Date       | Author(s)   | Summary of Changes                                                |
| :------ | :--------- | :---------- | :------------------------------------------------------------------ |
| 1.0     | 1 Jun 2025 | ERIK SUPIT  | Initial MVP draft of the Database Design Document for `Agent-Makalah`. |
|         |            |             |                                                                     |
|         |            |             |                                                                     |